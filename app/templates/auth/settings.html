{% extends "layout.html" %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="card mb-4">
            <div class="card-body text-center">
                <img src="{{ url_for('static', filename='profile_pics/' + current_user.image_file) }}"
                     class="rounded-circle img-fluid mb-3" style="width: 150px; height: 150px; object-fit: cover;"
                     alt="用户头像">
                <h5 class="card-title">{{ current_user.username }}</h5>
                <p class="text-muted">{{ current_user.email }}</p>
            </div>
        </div>

        <div class="list-group">
            <a href="#basic" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                <i class="fas fa-user-edit"></i> 基本信息
            </a>
            <a href="#avatar" class="list-group-item list-group-item-action" data-bs-toggle="list">
                <i class="fas fa-camera"></i> 修改头像
            </a>
            <a href="#email" class="list-group-item list-group-item-action" data-bs-toggle="list">
                <i class="fas fa-envelope"></i> 邮箱设置
            </a>
            <a href="#notification" class="list-group-item list-group-item-action" data-bs-toggle="list">
                <i class="fas fa-bell"></i> 通知设置
            </a>
            <a href="#privacy" class="list-group-item list-group-item-action" data-bs-toggle="list">
                <i class="fas fa-shield-alt"></i> 隐私设置
            </a>
        </div>
    </div>

    <div class="col-md-9">
        <div class="card">
            <div class="card-body">
                <div class="tab-content">
                    <!-- 基本信息设置 -->
                    <div class="tab-pane fade show active" id="basic">
                        <h4 class="card-title mb-4">基本信息设置</h4>
                        <form method="POST" action="{{ url_for('auth.update_profile') }}">
                            {{ form.hidden_tag() }}
                            <div class="mb-3">
                                {{ form.username.label(class="form-label") }}
                                {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else "")) }}
                                {% for error in form.username.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="mb-3">
                                {{ form.bio.label(class="form-label") }}
                                {{ form.bio(class="form-control" + (" is-invalid" if form.bio.errors else ""), rows="3") }}
                                {% for error in form.bio.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <button type="submit" class="btn btn-primary">保存更改</button>
                        </form>
                    </div>

                    <!-- 头像设置 -->
                    <div class="tab-pane fade" id="avatar">
                        <h4 class="card-title mb-4">修改头像</h4>
                        <form method="POST" action="{{ url_for('auth.update_avatar') }}" enctype="multipart/form-data">
                            {{ avatar_form.hidden_tag() }}
                            <div class="mb-3">
                                <div class="d-flex align-items-center">
                                    <img src="{{ url_for('static', filename='profile_pics/' + current_user.image_file) }}"
                                         class="rounded-circle me-3" style="width: 100px; height: 100px; object-fit: cover;"
                                         alt="当前头像">
                                    <div>
                                        {{ avatar_form.image(class="form-control" + (" is-invalid" if avatar_form.image.errors else "")) }}
                                        {% for error in avatar_form.image.errors %}
                                            <div class="invalid-feedback">{{ error }}</div>
                                        {% endfor %}
                                        <small class="form-text text-muted">支持 JPG、PNG 格式，最大 5MB</small>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">上传新头像</button>
                        </form>
                    </div>

                    <!-- 邮箱设置 -->
                    <div class="tab-pane fade" id="email">
                        <h4 class="card-title mb-4">邮箱设置</h4>
                        <form method="POST" action="{{ url_for('auth.update_email') }}">
                            {{ email_form.hidden_tag() }}
                            <div class="mb-3">
                                <label class="form-label">当前邮箱</label>
                                <input type="email" class="form-control" value="{{ current_user.email }}" disabled>
                            </div>
                            <div class="mb-3">
                                {{ email_form.new_email.label(class="form-label") }}
                                {{ email_form.new_email(class="form-control" + (" is-invalid" if email_form.new_email.errors else "")) }}
                                {% for error in email_form.new_email.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="mb-3">
                                {{ email_form.password.label(class="form-label") }}
                                {{ email_form.password(class="form-control" + (" is-invalid" if email_form.password.errors else "")) }}
                                {% for error in email_form.password.errors %}
                                    <div class="invalid-feedback">{{ error }}</div>
                                {% endfor %}
                            </div>
                            <button type="submit" class="btn btn-primary">更新邮箱</button>
                        </form>
                    </div>

                    <!-- 通知设置 -->
                    <div class="tab-pane fade" id="notification">
                        <h4 class="card-title mb-4">通知设置</h4>
                        <form method="POST" action="{{ url_for('auth.update_notifications') }}">
                            {{ notification_form.hidden_tag() }}
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ notification_form.email_notifications(class="form-check-input") }}
                                    {{ notification_form.email_notifications.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ notification_form.comment_notifications(class="form-check-input") }}
                                    {{ notification_form.comment_notifications.label(class="form-check-label") }}
                                </div>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ notification_form.team_notifications(class="form-check-input") }}
                                    {{ notification_form.team_notifications.label(class="form-check-label") }}
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">保存设置</button>
                        </form>
                    </div>

                    <!-- 隐私设置 -->
                    <div class="tab-pane fade" id="privacy">
                        <h4 class="card-title mb-4">隐私设置</h4>
                        <form method="POST" action="{{ url_for('auth.update_privacy') }}">
                            {{ privacy_form.hidden_tag() }}
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ privacy_form.profile_public(class="form-check-input") }}
                                    {{ privacy_form.profile_public.label(class="form-check-label") }}
                                </div>
                                <small class="form-text text-muted">允许其他用户查看您的个人资料</small>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ privacy_form.show_email(class="form-check-input") }}
                                    {{ privacy_form.show_email.label(class="form-check-label") }}
                                </div>
                                <small class="form-text text-muted">在个人资料中显示您的邮箱地址</small>
                            </div>
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    {{ privacy_form.show_activity(class="form-check-input") }}
                                    {{ privacy_form.show_activity.label(class="form-check-label") }}
                                </div>
                                <small class="form-text text-muted">显示您的活动历史</small>
                            </div>
                            <button type="submit" class="btn btn-primary">保存设置</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 从 URL hash 激活对应的标签页
    const hash = window.location.hash || '#basic';
    const tab = document.querySelector(`a[href="${hash}"]`);
    if (tab) {
        new bootstrap.Tab(tab).show();
    }

    // 更新 URL hash 当标签页改变时
    const tabs = document.querySelectorAll('[data-bs-toggle="list"]');
    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            window.location.hash = e.target.getAttribute('href');
        });
    });
});
</script>
{% endblock scripts %} 